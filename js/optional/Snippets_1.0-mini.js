const SCOPES={"text.html":{p:{replace:"<p>\n$0\n</p>"},span:{replace:'<span id="$1" class="$2">$3</span>$0'},divp:{replace:"<div class='p'>\n$0\n</div>"}},"text.erb":{"#":{replace:"<%# $0 %>"},"---":{replace:"-----------------------------------------------------------------------"}}};void 0==window.Snippets&&(window.Snippets={}),$.extend(window.Snippets,{ON_RETURN:null,ON_CMD_RETURN:null,ON_META_KEY:null,ON_CTRL_KEY:null,ON_ALT_KEY:null,data_snippets:null,snippets:new Object,set_scopes_to:function(t){var e,i={};$.each(t,function(t,n){e="string"==typeof n?SCOPES[n]:n,"object"==typeof e?$.extend(i,e):F.error("Le scope "+n+" devrait \xeatre un objet d\xe9finissant les snippets.")}),this.data_snippets=i},watch:function(t){$(t).bind("keypress",$.proxy(Snippets,"on_keypress",t))},unwatch:function(t){$(t).unbind("keypress",$.proxy(Snippets,"on_keypress",t))},watch_multiselect:function(t){$(t).bind("keydown",$.proxy(Snippets,"on_keydown",t)),$(t).bind("keypress",$.proxy(Snippets,"on_keypress_multiselect",t))},unwatch_multiselect:function(t){$(t).unbind("keydown",$.proxy(Snippets,"on_keydown",t)),$(t).unbind("keypress",$.proxy(Snippets,"on_keypress_multiselect",t))},on_keydown:function(t,e){this.current_offset_in_jid=e.currentTarget.selectionEnd},on_keypress:function(t,e){if(e.metaKey&&this.ON_META_KEY)return this.ON_META_KEY(e);if(e.ctrlKey&&this.ON_CTRL_KEY)return this.ON_CTRL_KEY(e);if(e.altKey&&this.ON_ALT_KEY)return this.ON_ALT_KEY(e);switch(e.keyCode){case 9:return this.current_field=$(t)[0],this.exec(t),!1;case 13:if(e.metaKey&&this.ON_CMD_RETURN)return this.ON_CMD_RETURN(),!1;if(this.ON_RETURN)return this.ON_RETURN(),!1}return!0},on_keypress_multiselect:function(t,e){return 9!=e.keyCode?!0:(this.snippets[t].next_selection(),!1)},exec:function(t){var e=new Snippet({jid:t});return e.is_not_a_snippet?(e.error_not_a_snippet(),!1):(e.replace_and_wait(),!1)}}),window.Snippet=function(t){this.id=Snippet.new_id(),this.jid=t.jid,this.dom_owner=$(t.jid)[0],Snippet.list[this.id]=this,Snippets.snippets[this.jid]=this},$.extend(Snippet,{list:[],last_id:0,new_id:function(){return this.last_id++,this.last_id}}),window.Snippet.prototype={replace_and_wait:function(){this.select_trigger(),this.replace_selection_content_with(this.text),this.affiche_help_if_needed(),this.first_selection()},affiche_help_if_needed:function(){0!=$("#snippets_help").length&&$("#snippets_help").html(this.help||"")},select_trigger:function(){this.dom_owner.setSelectionRange(this.offset,this.offset+this.trigger.length)},first_selection:function(){switch(this.set_selection_to({start:this.offset,end:this.offset}),this.selections.length){case 0:var t=this.offset+this.text.length;this.set_selection_to({start:t});break;case 1:break;default:Snippets.unwatch(this.jid),Snippets.watch_multiselect(this.jid)}this.next_selection()},next_selection:function(){var t=this.selections.shift();if(void 0==t)return this.has_multi_variables_dollar&&(Snippets.unwatch_multiselect(this.jid),Snippets.watch(this.jid)),!1;var e=this.dom_owner.selectionStart+t.offset,i=0+e+t.length,n={start:e,end:i};return this.set_selection_to(n),!0},replace_selection_content_with:function(t){var e=this.dom_owner,i=(e.scrollTop,Selection.of(e),e.value),n=e.selectionStart,s=e.selectionEnd,r=i.substring(0,n),o=i.substring(s,i.length);e.value=r+t+o},set_selection_to:function(t){void 0==t.end&&(t.end=t.start),this.dom_owner.setSelectionRange(t.start,t.end)},error_not_a_snippet:function(){return Flash.show("`"+this.trigger+"` n'est pas un snippet connu."),!1},get_selections:function(){for(var t,e,i="".concat(this.text),n=new Array,s="";null!=(t=i.match(/\$[0-9]/));)e=t[0],n[e]=t.index+s.length,s=s.concat(i.substring(0,t.index+1)),i=i.substring(t.index+1,i.length);selects=new Array;for(var r=0,o=1;10>o;++o){var _="$"+o,p=n[_];void 0!=p&&(selects.push({offset:p-r,length:_.length}),r=0+p+_.length)}return void 0!=n.$0&&selects.push({offset:n.$0-r,length:2}),this.has_multi_variables_dollar=selects.length>0,selects}},Object.defineProperties(Snippet.prototype,{selections:{get:function(){return void 0==this._selections&&(this._selections=this.get_selections()),this._selections}},is_snippet:{get:function(){return void 0!=this.data}},is_not_a_snippet:{get:function(){return!this.is_snippet}},data:{get:function(){return void 0==this._data&&(this._data=Snippets.data_snippets[this.trigger]),this._data}},text:{get:function(){return this.data.replace}},help:{get:function(){return this.data.help}},offset:{get:function(){return this._offset}},trigger:{get:function(){if(void 0==this._trigger){for(var t=this.dom_owner,e=t.value,i=parseInt(t.selectionStart),n=new RegExp("[^a-zA-Z._-]"),s=-1+i;s>=0&&!n.test(e.charAt(s));--s);this._char_before_trigger=e.substring(s,s+1),this._trigger=e.substring(s+1,i),this._offset=parseInt(s+1)}return this._trigger}},char_before_trigger:{get:function(){return this._char_before_trigger}}});